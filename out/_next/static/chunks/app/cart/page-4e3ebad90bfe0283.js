(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[565],{4010:function(e,t,r){Promise.resolve().then(r.bind(r,3546))},3546:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return P}});var s=r(7437),a=r(9910),n=r(2265),i=r(3537),l=r(7345),d=r(357);function c(){let e=(0,l.useStripe)(),t=(0,l.useElements)(),[r,a]=(0,n.useState)(null),[i,c]=(0,n.useState)(!1);(0,n.useEffect)(()=>{if(!e)return;let t=new URLSearchParams(window.location.search).get("payment_intent_client_secret");t&&(null==e||e.retrievePaymentIntent(t).then(e=>{let{paymentIntent:t}=e;switch(null==t?void 0:t.status){case"succeeded":a("Payment succeeded!");break;case"processing":a("Your payment is processing.");break;case"requires_payment_method":a("Your payment was not successful, please try again.");break;default:a("Something went wrong.")}}))},[e]);let o=async r=>{if(r.preventDefault(),!e||!t)return;c(!0);let{error:s}=await e.confirmPayment({elements:t,confirmParams:{return_url:"".concat(d.env.DOMAIN_URL,"/order/success")}});"card_error"===s.type||"validation_error"===s.type?a(s.message||"An unexpected error occurred."):a("An unexpected error occurred."),c(!1)};return(0,s.jsxs)("form",{id:"payment-form",onSubmit:o,children:[(0,s.jsx)(l.PaymentElement,{id:"payment-element",options:{layout:"accordion"}}),(0,s.jsx)("button",{disabled:i||!e||!t,id:"submit",className:"mt-4 w-full text-white bg-fta-primary-500 hover:bg-fta-primary-600 focus:ring-4 focus:outline-none focus:ring-fta-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center",children:(0,s.jsx)("span",{id:"button-text",children:i?(0,s.jsx)("div",{className:"spinner",id:"spinner"}):"Pay now"})}),r&&(0,s.jsx)("div",{id:"payment-message",children:r})]})}var o=r(6648),u=r(8347),m=r(7138);function p(e){let{item:t,index:r,length:i}=e,{setQuantity:l,removeItem:d,setSkuValue:c}=(0,a.x)(),[p,x]=(0,n.useState)(["L","M","S","XS"]),[h,f]=(0,n.useState)([]),[y,j]=(0,n.useState)(0),[g,N]=(0,n.useState)(!0);(0,n.useEffect)(()=>{b()},[]);let b=()=>{f(p.map(e=>({value:e,label:e}))),t.price_off>0&&j(100-t.price_off),r===i-1&&N(!1)};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"md:col-span-2 rounded-md",children:(0,s.jsx)("div",{className:"items-center gap-4",children:(0,s.jsxs)("div",{className:"md:col-span-2 flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-32 h-32 shrink-0 border rounded bg-white",children:(0,s.jsx)(o.default,{src:t.main_img,alt:t.title,objectFit:"fixed",width:96,height:96,className:"rounded h-full w-full "})}),(0,s.jsxs)("div",{className:"w-full ml-0 md:ml-4",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h3",{className:"text-md font-bold text-gray-800 truncate",children:(0,s.jsx)(m.default,{href:"/product/".concat(t.product_id),children:(0,s.jsx)("div",{className:"text-sm text-pretty font-extrabold text-fta-primary-800 h-10 line-clamp-2",children:t.title})})}),(0,s.jsx)("h6",{onClick:()=>d(t.product_id),className:"text-sm text-blue-500 cursor-pointer mt-0.5",children:"Remove"})]}),(0,s.jsx)("div",{className:"flex items-center justify-end",children:(0,s.jsxs)("div",{className:"flex justify-center items-end font-sans",children:[t.old_price*t.quantity>0&&(0,s.jsxs)("span",{className:"text-gray-500 line-through text-sm mr-2",children:["$",t.old_price*t.quantity]}),(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsxs)("div",{className:"text-gray-800 text-md font-bold",children:["$",t.price*t.quantity]}),(0,s.jsx)("div",{className:"text-red-600 text-sm font-bold px-2",children:t.price_off>0?"(-".concat(100-t.price_off,"%)"):""})]})]})}),(0,s.jsxs)("div",{className:"flex gap-4 mt-1 md:mt-2",children:[(0,s.jsx)("div",{className:"relative group bg-white",children:(0,s.jsx)("div",{children:(0,s.jsx)(u.default,{defaultValue:t.size,style:{width:80},options:h,onChange:e=>{c(t.product_id,e)}})})}),(0,s.jsx)("div",{children:(0,s.jsx)("div",{className:"bg-white",children:(0,s.jsxs)("div",{className:"flex items-center border border-gray-300 text-gray-800 text-md outline-none bg-transparent rounded",children:[(0,s.jsx)("div",{onClick:()=>{t.quantity>1&&l(t.product_id,t.quantity-1)},className:"px-3 py-3 cursor-pointer bg-orange-50  rounded-l ",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-2.5 fill-current",viewBox:"0 0 124 124",children:(0,s.jsx)("path",{d:"M112 50H12C5.4 50 0 55.4 0 62s5.4 12 12 12h100c6.6 0 12-5.4 12-12s-5.4-12-12-12z","data-original":"#000000"})})}),(0,s.jsx)("span",{className:"mx-2.5 w-5 text-center",children:t.quantity}),(0,s.jsx)("div",{onClick:()=>{l(t.product_id,t.quantity+1)},className:"px-3 cursor-pointer py-3 bg-orange-50 rounded-r",children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"w-2.5 fill-current",viewBox:"0 0 42 42",children:(0,s.jsx)("path",{d:"M37.059 16H26V4.941C26 2.224 23.718 0 21 0s-5 2.224-5 4.941V16H4.941C2.224 16 0 18.282 0 21s2.224 5 4.941 5H16v11.059C16 39.776 18.282 42 21 42s5-2.224 5-4.941V26h11.059C39.776 26 42 23.718 42 21s-2.224-5-4.941-5z","data-original":"#000000"})})})]})})})]})]})]})})}),g&&(0,s.jsx)("hr",{className:"border-gray-black my-6"})]})}var x=r(7394),h=r(1080),f=r(4110),y=r(9262),j=r(4069),g=r(6463),N=r(6508);let b=e=>(0,N.Z)({url:"/orders/create",method:"post",data:e}),v=()=>(0,N.Z)({url:"/orders/orderid",method:"get"}),w=()=>{let{items:e,totalPrice:t,clearCart:r}=(0,a.x)(),{createOrder:s}=(0,y.L)(),{user:n}=(0,j.t)(),i=(0,g.useRouter)();return{handleBuyNow:async a=>{let l;if(0===e.length){alert("No products selected");return}if(!n||!n.userId){alert("Plase log in to complete the purchase."),i.push("/login");return}try{l=(await v()).data}catch(e){console.error("Error creating order:",e);return}let d=[],c=!1;a.length>0?d=a:(d=e,c=!0);let o={orderId:l,userId:n.userId,totalPrice:t,paymentMethod:"pending",orderStatus:"pending",shippingMethod:"standard",shippingPrice:10,shippingAddressId:0,products:d.map(e=>({order_id:l,user_id:n.userId,product_id:e.product_id,title:e.title,old_price:e.old_price,price_off:e.price_off,price:e.price,quantity:e.quantity,main_img:e.main_img,size:e.size,color:e.color}))};s(o);try{let e=await b(o);console.log("订单创建成功:",e),0===e.code&&c&&r(),i.push("/checkout")}catch(e){console.error("订单创建失败:",e),alert("订单创建失败，请稍后再试。")}}}};function _(){let[e,t]=(0,n.useState)(!1),{items:r,totalPrice:i,price:l}=(0,a.x)(),{handleBuyNow:d}=w();return(0,s.jsx)(s.Fragment,{children:(0,s.jsx)(x.Z,{gap:"middle",vertical:!0,children:(0,s.jsx)(h.Z,{spinning:e,size:"large",tip:"Loading...",children:(0,s.jsxs)("div",{className:"flex flex-col  md:flex-row ",children:[(0,s.jsx)("div",{className:"flex-1 bg-background-back0 border rounded-md p-2 md:p-4",children:(0,s.jsx)("div",{className:"p-0 md:p-4",children:r.map((e,t)=>(0,s.jsx)(p,{item:e,length:r.length,index:t},e.product_id))})}),(0,s.jsx)("div",{className:"w-full md:w-1/4 md:ml-8 sx:ml-0 ",children:(0,s.jsxs)("div",{className:"border rounded-md md:mt-0 mt-4 sm:ml-0 p-4 bg-background-back1",children:[(0,s.jsx)("div",{className:"px-4",children:(0,s.jsx)("h2",{className:"text-2xl font-bold",children:"Cart total"})}),(0,s.jsx)(f.Z,{}),(0,s.jsxs)("div",{className:"px-4 text-gray-800 space-y-2",children:[(0,s.jsxs)("p",{className:"flex justify-between py-1",children:[(0,s.jsx)("span",{className:"text-base",children:"Now Total"}),(0,s.jsxs)("span",{className:"ml-auto text-red-500 font-bold",children:["$",i]})]}),(0,s.jsxs)("p",{className:"flex justify-between py-1",children:[(0,s.jsx)("span",{className:"text-base",children:"Total"}),(0,s.jsxs)("span",{className:"ml-auto line-through",children:["$",l.toFixed(2)]})]}),(0,s.jsxs)("p",{className:"flex justify-between py-1",children:[(0,s.jsx)("span",{className:"text-base",children:"Save"}),(0,s.jsxs)("span",{className:"ml-auto",children:["$",(l-i).toFixed(2)]})]}),(0,s.jsxs)("p",{className:"flex justify-between py-1",children:[(0,s.jsx)("span",{className:"text-base",children:"Discount"}),(0,s.jsx)("span",{className:"ml-auto font-bold",children:"$0.00"})]}),(0,s.jsxs)("p",{className:"flex justify-between py-1",children:[(0,s.jsx)("span",{className:"text-base",children:"Tax"}),(0,s.jsx)("span",{className:"ml-auto font-bold",children:"$0.00"})]}),(0,s.jsxs)("p",{className:"flex justify-between py-1",children:[(0,s.jsx)("span",{className:"text-base",children:"Fee"}),(0,s.jsx)("span",{className:"ml-auto font-bold",children:"$0.00"})]})]}),(0,s.jsx)(f.Z,{}),(0,s.jsx)("div",{className:"px-4",children:(0,s.jsxs)("div",{className:"flex justify-between font-bold text-lg mt-4",children:[(0,s.jsx)("span",{children:"Total"}),(0,s.jsxs)("span",{className:"text-red-500",children:["$",i]})]})}),(0,s.jsxs)("div",{className:"mt-8 space-y-4",children:[(0,s.jsx)("button",{onClick:()=>{t(!0),d(r)},className:"text-sm px-4 py-2.5 w-full font-semibold tracking-wide bg-fta-primary-500 hover:bg-fta-primary-600 text-white rounded-md",children:"Buy Now"}),(0,s.jsx)("div",{className:"w-4"}),(0,s.jsx)(m.default,{href:"/",children:(0,s.jsx)("button",{className:"text-sm px-4 py-2.5 w-full font-semibold tracking-wide bg-fta-background-100 hover:bg-fta-background-100 border text-fta-primary-500 rounded-md",children:"Continue Shopping"})})]})]})})]})})})})}var C=r(357);let q=(0,i.J)(C.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY);function P(){let{items:e,addItem:t,removeItem:r,totalPrice:i}=(0,a.x)(),[d,o]=(0,n.useState)(null);return(0,s.jsxs)("div",{className:"relative mx-auto max-w-c-1280 py-5 justify-between align-items:flex-end px-2 md:px-8 2xl:px-0",children:[(0,s.jsx)("div",{children:(0,s.jsxs)("ul",{className:"flex items-center font-[sans-serif] space-x-4 mb-4",children:[(0,s.jsx)(m.default,{href:"/",passHref:!0,children:(0,s.jsx)("li",{className:"text-gray-500 text-base cursor-pointer",children:"Home"})}),(0,s.jsx)("li",{children:(0,s.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"fill-gray-400 w-3.5 -rotate-90",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{"fill-rule":"evenodd",d:"M11.99997 18.1669a2.38 2.38 0 0 1-1.68266-.69733l-9.52-9.52a2.38 2.38 0 1 1 3.36532-3.36532l7.83734 7.83734 7.83734-7.83734a2.38 2.38 0 1 1 3.36532 3.36532l-9.52 9.52a2.38 2.38 0 0 1-1.68266.69734z",clipRule:"evenodd","data-original":"#000000"})})}),(0,s.jsx)("li",{className:"text-gray-800 text-base font-bold cursor-pointer",children:"Shopping Cart"})]})}),(0,s.jsx)("h1",{className:"text-xl md:text-3xl py-1 md:py-4 mb-2",children:"Shopping Cart"}),0===e.length?(0,s.jsx)("div",{className:"w-full max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,s.jsx)("div",{className:"bg-white sm:rounded-lg p-6 text-center",children:(0,s.jsx)("p",{className:"text-3xl lg:h-96",children:"Your cart is empty"})})}):(0,s.jsx)(_,{}),(0,s.jsx)("div",{className:"mb-8",children:d&&(0,s.jsx)(l.Elements,{stripe:q,options:{clientSecret:d},children:(0,s.jsx)(c,{})})})]})}},9910:function(e,t,r){"use strict";r.d(t,{x:function(){return u}});var s=r(9099),a=r(9291),n=r(6508);let i=()=>(0,n.Z)({url:"/cart/list",method:"post"}),l=e=>(0,n.Z)({url:"/cart/add",method:"post",data:e}),d=e=>(0,n.Z)({url:"/cart/update",method:"post",data:e}),c=e=>(0,n.Z)({url:"/cart/delete",method:"post",data:e}),o=e=>(0,n.Z)({url:"/cart/deleteone",method:"post",data:e}),u=(0,s.Ue)()((0,a.tJ)((e,t)=>({items:[],totalQuantity:0,totalPrice:0,price:0,discount:0,couponCode:null,addItem:r=>e(e=>{let s,a=e.items.filter(e=>null!==e);a.find(e=>e.product_id===r.product_id)?(s=a.map(e=>e.product_id===r.product_id?{...e,quantity:e.quantity+r.quantity}:e),setImmediate(async()=>{await t().updateCart(r)})):(s=[...a,r],setImmediate(async()=>{await t().createCart(r)}));let n=s.reduce((e,t)=>e+t.price*t.quantity,0);return{items:s,totalQuantity:s.reduce((e,t)=>e+t.quantity,0),price:s.reduce((e,t)=>e+t.old_price*t.quantity,0),totalPrice:n-t().discount}}),removeItem:r=>e(e=>{if(e.items.filter(e=>e.product_id===r).length>0){let s=e.items.filter(e=>e.product_id!==r),a=s.reduce((e,t)=>e+t.price*t.quantity,0);return{items:s,totalQuantity:s.reduce((e,t)=>e+t.quantity,0),price:s.reduce((e,t)=>e+t.old_price*t.quantity,0),totalPrice:a-t().discount}}return e}),clearCart:()=>{e({items:[],totalQuantity:0,totalPrice:0,discount:0,couponCode:null})},clearCartItem:e=>{t().deleteCart(e),t().clearCart()},setQuantity:(r,s)=>e(e=>{let a=e.items.filter(e=>null!==e),n=a.map(e=>e.product_id===r?{...e,quantity:Math.max(0,s)}:e).filter(e=>e.quantity>0),i=n.reduce((e,t)=>e+t.price*t.quantity,0),l=a.find(e=>e.product_id===r);return l&&setImmediate(async()=>{await t().updateCart({...l,quantity:s})}),{items:n,totalQuantity:n.reduce((e,t)=>e+t.quantity,0),price:n.reduce((e,t)=>e+t.old_price*t.quantity,0),totalPrice:i-t().discount}}),setSkuValue:(r,s)=>e(e=>{let a=e.items.filter(e=>null!==e),n=a.map(e=>e.product_id===r?{...e,size:s}:e).filter(e=>e.quantity>0),i=a.find(e=>e.product_id===r);return i&&setImmediate(async()=>{await t().updateCart(i)}),{items:n}}),applyCoupon:(r,s)=>{e({couponCode:r,discount:s,totalPrice:t().items.reduce((e,t)=>e+t.price*t.quantity,0)-s})},removeCoupon:()=>{e({couponCode:null,discount:0,totalPrice:t().items.reduce((e,t)=>e+t.price*t.quantity,0)})},fetchCartItems:async()=>{let t=await i();console.error("fetchCartItems response  object",t);let r=t.data;if(null==r?void 0:r.length){let t=r.reduce((e,t)=>e+t.price*t.quantity,0),s=r.reduce((e,t)=>e+t.quantity,0),a=r.reduce((e,t)=>e+t.old_price*t.quantity,0);e({items:r,totalPrice:t,totalQuantity:s,price:a})}else e({items:[]})},updateCart:async e=>{console.error("updateCartItem",await d(e))},deleteCart:async e=>{console.error("deleteCartItem",await c(e))},deleteCartOne:async e=>{console.error("deleteCartItemOne",await o(e))},createCart:async e=>{console.error("createCartItem",await l(e))}}),{name:"cart-storage",storage:(0,a.FL)(()=>localStorage)}))},9262:function(e,t,r){"use strict";r.d(t,{L:function(){return n}});var s=r(9099),a=r(9291);let n=(0,s.Ue)()((0,a.tJ)(e=>({order:null,addProduct:t=>e(e=>{if(!e.order)return{order:null};let r=[...e.order.products,t],s=r.reduce((e,t)=>e+t.price*t.quantity,0);return{order:{...e.order,products:r,totalPrice:s}}}),createOrder:t=>e(()=>({order:t})),removeProduct:t=>e(e=>{if(!e.order)return{order:null};let r=e.order.products.filter(e=>e.product_id!==t),s=r.reduce((e,t)=>e+t.price*t.quantity,0);return{order:{...e.order,products:r,totalPrice:s}}}),updateOrder:t=>e(e=>({order:e.order?{...e.order,...t}:null})),clearOrder:()=>e(()=>({order:null}))}),{name:"order-storage",storage:(0,a.FL)(()=>localStorage)}))},4069:function(e,t,r){"use strict";r.d(t,{t:function(){return n}});var s=r(9099),a=r(9291);let n=(0,s.Ue)()((0,a.tJ)(e=>({token:null,user:null,setUser:t=>e({user:t}),setAuth:(t,r)=>e({token:t,user:r}),clearAuth:()=>e({token:null,user:null})}),{name:"auth-storage",storage:(0,a.FL)(()=>localStorage),migrate:e=>!e.expiresAt||new Date(e.expiresAt)<new Date?{token:null,user:null}:e}))},6508:function(e,t,r){"use strict";var s=r(8472),a=r(7928),n=r(4069);let i=s.Z.create({baseURL:"https://api.dms.pub/api/web",timeout:5e3});i.interceptors.request.use(e=>{let{token:t,user:r}=n.t.getState();return t&&(e.headers=e.headers||{},e.headers["x-token"]=t),(null==r?void 0:r.userId)&&(e.headers=e.headers||{},e.headers["x-user-id"]=r.userId),e.headers=e.headers||{},e.headers["Content-Type"]="application/json",e},e=>(a.ZP.destroy,a.ZP.error({content:"请求错误，请稍后再试",duration:5}),Promise.reject(e))),i.interceptors.response.use(e=>{let{status:t,data:r}=e;if(200===t)return 0===r.code?r:Promise.reject(r)},e=>{let{response:t}=e,{clearAuth:r}=n.t.getState();return a.ZP.destroy(),JSON.stringify(e).includes("Network Error")?a.ZP.error({content:"网络超时",duration:5}):t&&401===t.status?(a.ZP.error({content:"未授权，请重新登录",duration:5}),r()):a.ZP.error({content:"请求错误，状态码：".concat(null==t?void 0:t.status),duration:5}),Promise.reject(e)}),t.Z=i}},function(e){e.O(0,[453,925,633,648,566,138,181,466,44,971,23,744],function(){return e(e.s=4010)}),_N_E=e.O()}]);